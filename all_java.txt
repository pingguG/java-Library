===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\Library\LibraryMap.java =====
package Library;

import model.Book;
import model.User;

import java.util.*;

public class LibraryMap {
    private final List<Book> books;
    private final Map<String, User> users;

    public LibraryMap() {
        books = new ArrayList<>();
        users = new HashMap<>();
    }

    public void addBook(Book book) {
        books.add(book);
    }

    public List<Book> getBooks() {
        return books;
    }

    public Map<String, User> getUsers() {
        return users;
    }

    public boolean registerUser(User user) {
        for (User u : users.values()) {
            if (u.equals(user)) return false;
        }

        users.put(user.getUsername(), user);
        return true;
    }

    public Book findBookByTitle(String title) {
        for (Book book : books) {
            if (book.getTitle().equals(title)) {
                return book;
            }
        }
        return null;
    }

    public User findUserByUsername(String username) {
        return users.get(username);
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\Library\LibraryService.java =====
package Library;

import model.*;

import java.util.*;

public class LibraryService {
    private final LibraryMap libraryMap;

    public LibraryService(LibraryMap libraryMap) {
        this.libraryMap = libraryMap;
    }

    public User login(String username, String password) {
        if (username == null || password == null) return null;

        for (User user : libraryMap.getUsers().values()) {
            if (user.getUsername().equals(username) &&
                    user.checkPassword(password)) {
                return user;
            }
        }
        return null;
    }

    public List<Book> getAvailableBooks() {
        List<Book> availableList = new ArrayList<>();
        for (Book book : libraryMap.getBooks()) {
            if (book.isAvailable()) {
                availableList.add(book);
            }
        }
        return availableList;
    }

    public boolean addBook(User currentUser, String title, String author, String typeInput) {

        if (!(currentUser instanceof Admin)) return false;
        if (title == null || author == null) return false;
        if (libraryMap.findBookByTitle(title) != null) return false;

        Book book;
        switch (typeInput) {
            case "1" -> book = new PrintedBook(title, author);
            case "2" -> book = new eBook(title, author);
            default -> {
                return false;
            }
        }

        libraryMap.addBook(book);
        return true;
    }

    public boolean addUser(User currentUser, String username, String password, String typeInput) {

        if (!(currentUser instanceof Admin)) return false;
        if (username == null || password == null) return false;

        User newUser;
        switch (typeInput) {
            case "1" -> newUser = new Admin(username, password);
            case "2" -> newUser = new RegularUser(username, password);
            default -> {
                return false;
            }
        }

        return libraryMap.registerUser(newUser);
    }

    public boolean borrowBook(User user, String bookTitle) {
        if (!(user instanceof RegularUser regular)) return false;
        if (bookTitle == null) return false;

        Book book = libraryMap.findBookByTitle(bookTitle);
        if (book == null || !book.isAvailable()) return false;

        return regular.borrowBook(book);
    }

    public boolean returnBook(User user, String bookTitle) {
        if (!(user instanceof RegularUser regular)) return false;
        if (bookTitle == null) return false;

        Book book = libraryMap.findBookByTitle(bookTitle);
        if (book == null) return false;

        return regular.returnBook(book);
    }

    public List<Book> getBorrowedBooks(User currentUser) {
        if (!(currentUser instanceof RegularUser regularUser)) {
            return new ArrayList<>();
        }

        List<Book> borrowedBooks = new ArrayList<>();
        for (BorrowRecord record : regularUser.getBorrowedRecords()) {
            borrowedBooks.add(record.getBook());
        }
        return borrowedBooks;
    }

    public List<BorrowRecord> getOverdueBooks(User currentUser) {
        if (!(currentUser instanceof RegularUser regularUser)) return new ArrayList<>();

        List<BorrowRecord> overdueBooks = new ArrayList<>();
        for (BorrowRecord record : regularUser.getBorrowedRecords()) {
            if (record.isOverdue()) {
                overdueBooks.add(record);
            }
        }
        return overdueBooks;
    }

    public LibraryMap getLibraryMap() {
        return libraryMap;
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\Library\LibraryStorage.java =====
package Library;

import model.*;

import java.io.*;
import java.time.LocalDateTime;

import static util.MyLogger.log;

public class LibraryStorage {

    private static final String FILE_USERS = "users.txt";
    private static final String FILE_BOOKS = "books.txt";
    private static final String FILE_BORROW = "borrow.txt";

    private static final String DELIM_CHAR = "|";
    private static final String DELIM_REGEX = "\\|";

    public void save(LibraryMap map) {
        try {
            saveUsers(map);
            saveBooks(map);
            saveBorrowRecords(map);
        } catch (IOException e) {
            log(e);
        }
    }

    public void loadInto(LibraryMap map) {
        boolean userFileExists = new File(FILE_USERS).exists();
        boolean bookFileExists = new File(FILE_BOOKS).exists();

        if (!userFileExists && !bookFileExists) {
            initializeFirstTime(map);
            return;
        }

        try {
            loadUsers(map);
            loadBooks(map);
            loadBorrowRecords(map);
        } catch (IOException e) {
            log(e);
        }
    }


    private void initializeFirstTime(LibraryMap map) {
        map.registerUser(new Admin("admin", "123"));
        map.registerUser(new RegularUser("jack", "456"));
        map.registerUser(new RegularUser("yop", "789"));

        map.addBook(new PrintedBook("The Little Prince", "Saint-Exupery"));
        map.addBook(new eBook("Animal Farm: A Fairy Story", "George Orwell"));
        map.addBook(new PrintedBook("The Divine Comedy", "Dante"));
        map.addBook(new eBook("The Stranger", "Albert Camus"));
    }

    private void saveUsers(LibraryMap map) throws IOException {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(FILE_USERS))) {
            for (User user : map.getUsers().values()) {
                String type = (user instanceof Admin) ? "0" : "1";
                writer.write(user.getUsername() + DELIM_CHAR + user.getPassword() + DELIM_CHAR + type);
                writer.newLine();
            }
        }
    }

    private void saveBooks(LibraryMap map) throws IOException {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(FILE_BOOKS))) {
            for (Book book : map.getBooks()) {
                String type = (book instanceof PrintedBook) ? "0" : "1";
                writer.write(book.getTitle() + DELIM_CHAR + book.getAuthor() + DELIM_CHAR + type);
                writer.newLine();
            }
        }
    }

    private void saveBorrowRecords(LibraryMap map) throws IOException {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(FILE_BORROW))) {
            for (User user : map.getUsers().values()) {
                if (user instanceof RegularUser regular) {
                    for (BorrowRecord record : regular.getBorrowedRecords()) {
                        writer.write(user.getUsername() + DELIM_CHAR + record.getBook().getTitle() + DELIM_CHAR + record.getBorrowDate().toString() + DELIM_CHAR);
                        writer.newLine();
                    }
                }
            }
        }
    }


    private void loadUsers(LibraryMap map) throws IOException {
        File file = new File(FILE_USERS);
        if (!file.exists()) return;

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] p = line.split(DELIM_REGEX);
                String name = p[0];
                String pass = p[1];
                String type = p[2];

                if (type.equals("0")) {
                    map.registerUser(new Admin(name, pass));
                } else map.registerUser(new RegularUser(name, pass));
            }
        }
    }

    private void loadBooks(LibraryMap map) throws IOException {
        File file = new File(FILE_BOOKS);
        if (!file.exists()) return;

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] p = line.split(DELIM_REGEX);
                String title = p[0];
                String author = p[1];
                String type = p[2];

                Book book = type.equals("0") ? new PrintedBook(title, author) : new eBook(title, author);

                map.addBook(book);
            }
        }
    }

    private void loadBorrowRecords(LibraryMap map) throws IOException {
        File file = new File(FILE_BORROW);
        if (!file.exists()) return;

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] p = line.split(DELIM_REGEX);

                String username = p[0];
                String bookTitle = p[1];
                String borrowDateStr = p[2];

                User u = map.findUserByUsername(username);
                if (!(u instanceof RegularUser regular)) continue;

                Book b = map.findBookByTitle(bookTitle);
                if (b == null) continue;

                LocalDateTime borrowDate = LocalDateTime.parse(borrowDateStr);

                regular.addRecord(new BorrowRecord(b, borrowDate));
                b.borrow();
            }
        }
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\Admin.java =====
package model;

public class Admin extends User {
    public Admin(String username, String password) {
        super(username, password);
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\Book.java =====
package model;

public abstract class Book {
    private final String title;
    private final String author;
    private boolean isAvailable;

    public Book(String title, String author) {
        this.title = title;
        this.author = author;
        this.isAvailable = true;
    }

    public String getTitle() {
        return title;
    }

    public String getAuthor() {
        return author;
    }

    public boolean isAvailable() {
        return isAvailable;
    }

    public void borrow() {
        this.isAvailable = false;
    }

    public void returnBook() {
        this.isAvailable = true;
    }

    public abstract String showDetails();
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\BorrowRecord.java =====
package model;

import java.time.LocalDateTime;

public class BorrowRecord {
    private final Book book;
    private final LocalDateTime borrowDate;
    private final LocalDateTime dueDate;
    private static final int LOAN_TERM = 10;

    public BorrowRecord(Book book, LocalDateTime borrowDate) {
        this.book = book;
        this.borrowDate = borrowDate;
        this.dueDate = borrowDate.plusSeconds(LOAN_TERM);
    }

    public Book getBook() {
        return book;
    }

    public boolean isOverdue() {
        return LocalDateTime.now().isAfter(dueDate);
    }

    public LocalDateTime getBorrowDate() {
        return borrowDate;
    }

    @Override
    public String toString() {
        return book.getTitle() + " (Borrow: " + borrowDate + ", Due: " + dueDate + ")";
    }
}


===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\eBook.java =====
package model;

public class eBook extends Book {
    public eBook(String title, String author) {
        super(title, author);
    }

    @Override
    public String showDetails() {
        return "eBook: " + getTitle() + " by " + getAuthor();
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\PrintedBook.java =====
package model;

public class PrintedBook extends Book {
    public PrintedBook(String title, String author) {
        super(title, author);
    }

    @Override
    public String showDetails() {
        return "Printed Book: " + getTitle() + " by " + getAuthor();
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\RegularUser.java =====
package model;

import java.time.LocalDateTime;
import java.util.*;

public class RegularUser extends User {
    private final List<BorrowRecord> borrowedRecords;

    public RegularUser(String username, String password) {
        super(username, password);
        this.borrowedRecords = new ArrayList<>();
    }

    public boolean borrowBook(Book book) {
        if (book.isAvailable()) {
            book.borrow();
            addRecord(new BorrowRecord(book, LocalDateTime.now()));
            return true;
        } else {
            return false;
        }
    }

    public boolean returnBook(Book book) {
        BorrowRecord target = null;

        for (BorrowRecord record : borrowedRecords) {
            if (record.getBook().equals(book)) {
                target = record;
                break;
            }
        }

        if (target != null) {
            book.returnBook();
            borrowedRecords.remove(target);
            return true;
        }

        return false;
    }

    public void addRecord(BorrowRecord record) {
        borrowedRecords.add(record);
    }

    public List<BorrowRecord> getBorrowedRecords() {
        return borrowedRecords;
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\model\User.java =====
package model;

public abstract class User {
    private final String username;
    private final String password;

    public User(String username, String password) {
        this.username = username;
        this.password = password;
    }

    public String getUsername() {
        return username;
    }

    public String getPassword() {
        return password;
    }

    @Override
    public int hashCode() {
        return username.hashCode();
    }

    @Override
    public boolean equals(Object obj) {
        User user = (User) obj;
        return user.getUsername().equals(username);
    }

    public boolean checkPassword(String password) {
        return this.password.equals(password);
    }
}



===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\util\InputParse.java =====
package util;

public class InputParse {

    public static Integer parseInt(String msg) {
        if (msg == null) return null;

        try {
            return Integer.parseInt(msg);
        } catch (NumberFormatException e) {
            return null;
        }
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\util\MyLogger.java =====
package util;

import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

public class MyLogger {
    private static final DateTimeFormatter formatter = DateTimeFormatter.ofPattern("HH:mm:ss.SSS");
    public static void log(Object obj) {
        String time = LocalTime.now().format(formatter);
        System.out.printf("%s [%9s] %s\n", time, Thread.currentThread().getName(), obj);
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\util\SocketCloseUtil.java =====
package util;

import java.io.*;
import java.net.Socket;

import static util.MyLogger.log;

public class SocketCloseUtil {
    public static void closeAll(Socket socket, InputStream input, OutputStream output) {
        close(input);
        close(output);
        close(socket);
    }

    public static void close(InputStream input) {
        if (input != null) {
            try {
                input.close();
            } catch (IOException e) {
                log(e.getMessage());
            }
        }
    }

    public static void close(OutputStream output) {
        if (output != null) {
            try {
                output.close();
            } catch (IOException e) {
                log(e.getMessage());
            }
        }
    }

    public static void close(Socket socket) {
        if (socket != null) {
            try {
                socket.close();
            } catch (IOException e) {
                log(e.getMessage());
            }
        }
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\HttpRequest.java =====
package was.httpserver;

import java.io.*;
import java.net.*;
import java.util.*;

import static java.nio.charset.StandardCharsets.UTF_8;

public class HttpRequest {
    private String method;
    private String path;
    private final Map<String, String> queryParameters = new HashMap<>();
    private final Map<String, String> headers = new HashMap<>();
    private ServletManager servletManager;

    public HttpRequest(BufferedReader reader) throws IOException {
        parseRequestLine(reader);
        parseHeaders(reader);
    }

    private void parseRequestLine(BufferedReader reader) throws IOException {
        String requestLine = reader.readLine();
        if (requestLine == null) {
            throw new IOException("EOF: No request line received");
        }
        String[] parts = requestLine.split(" ");
        if (parts.length != 3) {
            throw new IOException("Invalid request line: " + requestLine);
        }
        method = parts[0];
        String[] pathParts = parts[1].split("\\?");
        path = pathParts[0];
        if (pathParts.length > 1) {
            parseQueryParameters(pathParts[1]);
        }
    }

    private void parseQueryParameters(String queryString) {
        for (String param : queryString.split("&")) {
            String[] keyValue = param.split("=");
            String key = URLDecoder.decode(keyValue[0], UTF_8);
            String value = keyValue.length > 1 ? URLDecoder.decode(keyValue[1], UTF_8) : "";
            queryParameters.put(key, value);
        }
    }

    private void parseHeaders(BufferedReader reader) throws IOException {
        String line;
        while (!(line = reader.readLine()).isEmpty()) {
            String[] headerParts = line.split(":");
            headers.put(headerParts[0].trim(), headerParts[1].trim());
        }
    }

    public String getPath() {
        return path;
    }

    public String getParameter(String name) {
        return queryParameters.get(name);
    }

    public void setServletManager(ServletManager servletManager) {
        this.servletManager = servletManager;
    }

    public ServletManager getServletManager() {
        return servletManager;
    }
    @Override
    public String toString() {
        return "HttpRequest{" + "method='" + method + '\'' + ", path='" + path + '\'' + ", queryParameters=" + queryParameters + ", headers=" + headers + '}';
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\HttpRequestHandlerV4.java =====
package was.httpserver;

import java.io.*;
import java.net.Socket;

import static java.nio.charset.StandardCharsets.UTF_8; //UTF瑜??명븯寃??곌린 ?꾪빐 ?묒꽦
import static util.MyLogger.log;

public class HttpRequestHandlerV4 implements Runnable {
    private final Socket socket;
    private final ServletManager servletManager;

    public HttpRequestHandlerV4(Socket socket, ServletManager servletManager) {
        this.socket = socket;
        this.servletManager = servletManager;
    }

    @Override
    public void run() {
        try {
            process();
        } catch (Exception e) {
            log(e);
        }
    }

    private void process() throws IOException {
        try (socket;
             BufferedReader reader = new BufferedReader(new InputStreamReader(socket.getInputStream(), UTF_8));
             PrintWriter writer = new PrintWriter(socket.getOutputStream(), false, UTF_8)) {
            HttpRequest request = new HttpRequest(reader);
            request.setServletManager(servletManager);
            HttpResponse response = new HttpResponse(writer);

            if (request.getPath().equals("/favicon.ico")) {
                log("favicon requests");
                return;
            }
            log("=== HTTP Request ===");
            System.out.println(request);
            servletManager.execute(request, response);
            response.flush();
        }
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\HttpResponse.java =====
package was.httpserver;

import java.io.*;

import static java.nio.charset.StandardCharsets.UTF_8;

public class HttpResponse {
    private final PrintWriter writer;
    private int statusCode = 200;
    private final StringBuilder bodyBuilder = new StringBuilder();

    private String contentType = "text/html; charset=UTF-8";

    public HttpResponse(PrintWriter writer) {
        this.writer = writer;
    }

    public void setStatusCode(int statusCode) {
        this.statusCode = statusCode;
    }

    public void writeBody(String body) {
        bodyBuilder.append(body);
    }

    public void flush() {
        int contentLength = bodyBuilder.toString().getBytes(UTF_8).length;
        writer.println("HTTP/1.1 " + statusCode + " " + getReasonPhrase(statusCode));
        writer.println("Content-Type: " + contentType);
        writer.println("Content-Length: " + contentLength);
        writer.println();
        writer.println(bodyBuilder);
        writer.flush();
    }

    public void sendDirect(String location) {
        writer.println("HTTP/1.1 302 Found");
        writer.println("Location: " + location);
        writer.println();
        writer.flush();
    }

    private String getReasonPhrase(int statusCode) {
        switch (statusCode) {
            case 200:
                return "OK";
            case 404:
                return "Not Found";
            case 500:
                return "Internal Server Error";
            default:
                return "Unknown Status";
        }
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\HttpServlet.java =====
package was.httpserver;

import java.io.IOException;

public interface HttpServlet {
    void service(HttpRequest request, HttpResponse response) throws IOException;
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\ServletManager.java =====
package was.httpserver;

import Library.LibraryService;
import was.version.servlet.*;

import java.io.*;
import java.util.*;

public class ServletManager {
    private final Map<String, HttpServlet> servletMap = new HashMap<>();
    private final HttpServlet notFoundServlet = new NotFoundServlet();
    private final LibraryService libraryService;
    private final SessionManager sessionManager;

    public ServletManager(LibraryService libraryService, SessionManager sessionManager) {
        this.libraryService = libraryService;
        this.sessionManager = sessionManager;
    }

    public LibraryService getLibraryService() {
        return libraryService;
    }

    public SessionManager getSessionManager() {
        return sessionManager;
    }

    public void add(String path, HttpServlet servlet) {
        servletMap.put(path, servlet);
    }

    public void execute(HttpRequest request, HttpResponse response) throws IOException {
        HttpServlet servlet = servletMap.getOrDefault(request.getPath(), notFoundServlet);
        servlet.service(request, response);
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\Session.java =====
package was.httpserver;

import model.*;

public class Session {

    private final User currentUser;

    public Session(User currentUser) {
        this.currentUser = currentUser;
    }

    public User getCurrentUser() {
        return currentUser;
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\httpserver\SessionManager.java =====
package was.httpserver;

import model.User;

import java.util.*;

public class SessionManager {
    private final Map<String, Session> sessions = new HashMap<>();

    public String createSession(User user) {
        String id = UUID.randomUUID().toString();

        Session session = new Session(user);
        sessions.put(id, session);

        return id;
    }

    public User getUser(String sessionId) {
        Session s = sessions.get(sessionId);
        if (s == null) return null;
        return s.getCurrentUser();
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\HttpServer.java =====
package was.version;

import Library.LibraryStorage;
import was.httpserver.*;

import java.io.*;
import java.net.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static util.MyLogger.log;

public class HttpServer {

    private final ExecutorService es = Executors.newFixedThreadPool(10);
    private final int port;
    private final ServletManager servletManager;
    private volatile boolean running = true;
    private final LibraryStorage storage;

    private ServerSocket serverSocket;

    public HttpServer(int port, ServletManager servletManager, LibraryStorage storage) {
        this.port = port;
        this.servletManager = servletManager;
        this.storage = storage;
    }

    public void start() throws IOException {
        serverSocket = new ServerSocket(port);
        log("HttpServer port: " + port);

        startConsoleListener();

        while (running) {
            try {
                Socket socket = serverSocket.accept();
                es.submit(new HttpRequestHandlerV4(socket, servletManager));
            } catch (IOException e) {
                if (!running) break;
            }
        }

        shutdown();
    }

    private void startConsoleListener() {
        Thread t = new Thread(() -> {
            BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));

            while (running) {
                try {
                    String line = reader.readLine();
                    if ("STOP".equals(line)) {
                        log("STOP command received");
                        running = false;
                        try {
                            serverSocket.close();
                        } catch (Exception ignored) {
                        }
                        return;
                    }
                } catch (IOException ignored) {
                }
            }
        });

        t.setDaemon(true);
        t.start();
    }

    private void shutdown() {
        log("Shutting down server...");

        es.shutdownNow();

        try {
            storage.save(servletManager.getLibraryService().getLibraryMap());
            log("Library saved.");
        } catch (Exception e) {
            log(e);
        }

        log("Server exit.");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\ServerMainV4.java =====
package was.version;

import was.httpserver.*;
import Library.*;
import was.version.servlet.*;
import was.version.servlet.admin.*;
import was.version.servlet.user.*;

import java.io.IOException;

public class ServerMainV4 {
    private static final int PORT = 12345;

    public static void main(String[] args) throws IOException {
        LibraryMap libraryMap = new LibraryMap();
        LibraryStorage storage = new LibraryStorage();
        storage.loadInto(libraryMap);

        LibraryService libraryService = new LibraryService(libraryMap);
        SessionManager sessionManager = new SessionManager();

        ServletManager servletManager = new ServletManager(libraryService, sessionManager);

        servletManager.add("/", new HomeServlet());
        servletManager.add("/login", new LoginServlet());
        servletManager.add("/admin", new AdminServlet());
        servletManager.add("/user", new UserServlet());

        servletManager.add("/addBook", new AddBookServlet());
        servletManager.add("/addUser", new AddUserServlet());

        servletManager.add("/bookList", new BookListServlet());
        servletManager.add("/borrowBook", new BorrowServlet());
        servletManager.add("/returnBook", new ReturnBookServlet());
        servletManager.add("/Overdue", new OverdueServlet());

        servletManager.add("/exit", new ExitServlet());

        HttpServer server = new HttpServer(PORT, servletManager, storage);
        server.start();
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\admin\AddBookServlet.java =====
package was.version.servlet.admin;

import Library.LibraryService;
import model.*;
import was.httpserver.*;

public class AddBookServlet implements HttpServlet {

    @Override
    public void service(HttpRequest request, HttpResponse response) {
        ServletManager manager = request.getServletManager();

        LibraryService libraryService = manager.getLibraryService();
        SessionManager sessionManager = manager.getSessionManager();

        String sid = request.getParameter("sessionId");
        String title = request.getParameter("title");
        String author = request.getParameter("author");
        String type = request.getParameter("type");

        User user = sessionManager.getUser(sid);

        if (title == null || author == null || type == null) {
            renderForm(response, sid);
            return;
        }

        boolean result = libraryService.addBook(user, title, author, type);
        if (result) {
            response.writeBody("<p>梨?異붽? ?깃났!</p>");
        } else {
            response.writeBody("<p>梨?異붽? ?ㅽ뙣!</p>");
        }

        response.writeBody("<a href='/admin?sessionId=" + sid + "'>?ㅻ줈媛湲?/a>");
    }

    private void renderForm(HttpResponse response, String sid) {

        response.writeBody("<h2>梨?異붽?</h2>");
        response.writeBody("<form action='/addBook' method='GET'>");
        response.writeBody("<input type='hidden' name='sessionId' value='" + sid + "'>");
        response.writeBody("""
                    <label>?쒕ぉ:</label><br>
                    <input type='text' name='title'><br><br>
                
                    <label>???</label><br>
                    <input type='text' name='author'><br><br>
                
                    <label>醫낅쪟:</label><br>
                    1: ?몄뇙蹂?br>
                    2: eBook<br>
                    <input type='text' name='type'><br><br>
                
                    <button type='submit'>異붽?</button>
                </form>
                <br>
                """);
        response.writeBody("<a href='/admin?sessionId=" + sid + "'>愿由ъ옄 硫붾돱濡?/a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\admin\AddUserServlet.java =====
package was.version.servlet.admin;

import Library.LibraryService;
import model.User;
import was.httpserver.*;

public class AddUserServlet implements HttpServlet {

    @Override
    public void service(HttpRequest request, HttpResponse response) {

        ServletManager manager = request.getServletManager();

        LibraryService libraryService = manager.getLibraryService();
        SessionManager sessionManager = manager.getSessionManager();

        String sid = request.getParameter("sessionId");
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        String type = request.getParameter("type");

        User user = sessionManager.getUser(sid);

        if (username == null || password == null || type == null) {
            renderForm(response, sid);
            return;
        }

        boolean result = libraryService.addUser(user, username, password, type);

        if (result) {
            response.writeBody("<p>?좎? ?앹꽦 ?깃났!</p>");
        } else {
            response.writeBody("<p>?좎? ?앹꽦 ?ㅽ뙣!</p>");
        }

        response.writeBody("<a href='/admin?sessionId=" + sid + "'>?ㅻ줈媛湲?/a>");
    }

    private void renderForm(HttpResponse response, String sid) {

        response.writeBody("<h2>?좎? ?앹꽦</h2>");
        response.writeBody("<form action='/addUser' method='GET'>");
        response.writeBody("<input type='hidden' name='sessionId' value='" + sid + "'>");
        response.writeBody("""
                    <label>?꾩씠??</label><br>
                    <input type='text' name='username'><br><br>
                
                    <label>鍮꾨?踰덊샇:</label><br>
                    <input type='password' name='password'><br><br>
                
                    <label>?좏삎:</label><br>
                    1: 愿由ъ옄<br>
                    2: ?쇰컲 ?ъ슜??br>
                    <input type='text' name='type'><br><br>
                
                    <button type='submit'>?앹꽦</button>
                </form>
                <br>
                """);
        response.writeBody("<a href='/admin?sessionId=" + sid + "'>愿由ъ옄 硫붾돱濡?/a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\admin\AdminServlet.java =====
package was.version.servlet.admin;

import was.httpserver.*;

import java.io.IOException;

public class AdminServlet implements HttpServlet {
    @Override
    public void service(HttpRequest request, HttpResponse response) throws IOException {

        String sid = request.getParameter("sessionId");

        response.writeBody("<h1>Admin 硫붾돱</h1>");

        response.writeBody("<ul>");
        response.writeBody("<li><a href='/addBook?sessionId=" + sid + "'>梨?異붽?</a></li>");
        response.writeBody("<li><a href='/addUser?sessionId=" + sid + "'>?좎? 異붽?</a></li>");
        response.writeBody("<li><a href='/'>?덉쑝濡?/a></li>");
        response.writeBody("</ul>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\ExitServlet.java =====
package was.version.servlet;

import was.httpserver.*;

public class ExitServlet implements HttpServlet {

    @Override
    public void service(HttpRequest request, HttpResponse response) {
        response.writeBody("<h1>Goodbye!</h1>");
        response.writeBody("<a href='/'>home</a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\HomeServlet.java =====
package was.version.servlet;

import was.httpserver.*;

import java.io.IOException;

public class HomeServlet implements HttpServlet {

    @Override
    public void service(HttpRequest request, HttpResponse response) throws IOException {
        response.writeBody("<h1>Library System</h1>");

        response.writeBody("<ul>");
        response.writeBody("<li><a href='/login'>濡쒓렇??/a></li>");
        response.writeBody("<li><a href='/exit'>醫낅즺</a></li>");
        response.writeBody("</ul>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\LoginServlet.java =====
package was.version.servlet;

import Library.LibraryService;
import model.*;
import was.httpserver.*;

public class LoginServlet implements HttpServlet {

    @Override
    public void service(HttpRequest request, HttpResponse response) {
        ServletManager manager = request.getServletManager();

        LibraryService libraryService = manager.getLibraryService();
        SessionManager sessionManager = manager.getSessionManager();

        String username = request.getParameter("username");
        String password = request.getParameter("password");

        if (username == null || password == null) {
            renderLoginForm(response, null);
            return;
        }

        User user = libraryService.login(username, password);

        if (user != null) {
            String sessionId = sessionManager.createSession(user);

            if (user instanceof Admin) {
                response.sendDirect("/admin?sessionId=" + sessionId);
                return;
            }

            if (user instanceof RegularUser) {
                response.sendDirect("/user?sessionId=" + sessionId);
                return;
            }

            response.sendDirect("/login");
            return;
        }

        renderLoginForm(response, "濡쒓렇???ㅽ뙣: ?섎せ???꾩씠??鍮꾨?踰덊샇");
    }

    private void renderLoginForm(HttpResponse response, String errorMessage) {

        if (errorMessage != null) {
            response.writeBody("<p style='color:red;'>" + errorMessage + "</p>");
        }

        response.writeBody("<h1>濡쒓렇??/h1>");
        response.writeBody("""
                <form action='/login' method='GET'>
                    <label>?꾩씠??</label><br>
                    <input type='text' name='username'><br><br>
                
                    <label>鍮꾨?踰덊샇:</label><br>
                    <input type='password' name='password'><br><br>
                
                    <button type='submit'>濡쒓렇??/button>
                </form>
                <br>
                """);
        response.writeBody("<a href='/'>?덉쑝濡?/a>");
    }
}


===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\NotFoundServlet.java =====
package was.version.servlet;

import was.httpserver.*;

public class NotFoundServlet implements HttpServlet {
    @Override
    public void service(HttpRequest request, HttpResponse response) {
        response.setStatusCode(404);
        response.writeBody("<h1>404 ?섏씠吏瑜쇱갼?꾩닔?놁뒿?덈떎.</h1>");
        response.writeBody("<a href='/'>home</a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\user\BookListServlet.java =====
package was.version.servlet.user;

import Library.LibraryService;
import model.*;
import was.httpserver.*;

import java.util.List;

public class BookListServlet implements HttpServlet {
    @Override
    public void service(HttpRequest request, HttpResponse response) {

        ServletManager manager = request.getServletManager();
        LibraryService libraryService = manager.getLibraryService();

        String sid = request.getParameter("sessionId");

        List<Book> books = libraryService.getAvailableBooks();

        response.writeBody("<h2>?異?媛?ν븳 ?꾩꽌 紐⑸줉</h2>");
        response.writeBody("<ul>");

        for (Book b : books) {
            response.writeBody("<li>");
            response.writeBody(b.getTitle() + " - " + b.getAuthor());
            response.writeBody("</li>");
        }

        response.writeBody("</ul>");
        response.writeBody("<a href='/user?sessionId=" + sid + "'>?ㅻ줈媛湲?/a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\user\BorrowServlet.java =====
package was.version.servlet.user;

import Library.LibraryService;
import model.*;
import was.httpserver.*;

import java.io.IOException;
import java.util.List;

public class BorrowServlet implements HttpServlet {
    @Override
    public void service(HttpRequest request, HttpResponse response) throws IOException {
        ServletManager manager = request.getServletManager();

        LibraryService libraryService = manager.getLibraryService();
        SessionManager sessionManager = manager.getSessionManager();

        String sid = request.getParameter("sessionId");
        String title = request.getParameter("title");

        User user = sessionManager.getUser(sid);

        if (title == null) {
            List<Book> books = libraryService.getAvailableBooks();

            response.writeBody("<h2>?異?媛?ν븳 ?꾩꽌 紐⑸줉</h2>");
            response.writeBody("<ul>");

            for (Book book : books) {
                response.writeBody("<li>");
                response.writeBody(book.getTitle() + " - " + book.getAuthor());
                response.writeBody(" <a href='/borrowBook?sessionId=" + sid
                        + "&title=" + book.getTitle() + "'>?異?/a>");
                response.writeBody("</li>");
            }

            response.writeBody("</ul>");
            response.writeBody("<a href='/user?sessionId=" + sid + "'>?ㅻ줈媛湲?/a>");
            return;
        }

        boolean result = libraryService.borrowBook(user, title);

        if (result) {
            response.writeBody("<p>" + title + " ?異??깃났!</p>");
        } else {
            response.writeBody("<p>?異??ㅽ뙣!</p>");
        }

        response.writeBody("<a href='/borrowBook?sessionId=" + sid + "'>?ㅻⅨ 梨?鍮뚮━湲?/a><br>");
        response.writeBody("<a href='/user?sessionId=" + sid + "'>?ъ슜??硫붾돱濡?/a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\user\OverdueServlet.java =====
package was.version.servlet.user;

import Library.LibraryService;
import model.*;
import was.httpserver.*;

import java.util.List;

public class OverdueServlet implements HttpServlet {

    @Override
    public void service(HttpRequest request, HttpResponse response) {
        ServletManager manager = request.getServletManager();

        LibraryService libraryService = manager.getLibraryService();
        SessionManager sessionManager = manager.getSessionManager();

        String sid = request.getParameter("sessionId");
        User user = sessionManager.getUser(sid);

        List<BorrowRecord> overdueList = libraryService.getOverdueBooks(user);

        response.writeBody("<h2>?곗껜 ?꾩꽌 紐⑸줉</h2>");
        response.writeBody("<ul>");

        for (BorrowRecord record : overdueList) {
            Book book = record.getBook();
            response.writeBody("<li>");
            response.writeBody(book.getTitle() + " - " + book.getAuthor() +
                    " (??ъ씪: " + record.getBorrowDate() + ")");
            response.writeBody("</li>");
        }

        response.writeBody("</ul>");
        response.writeBody("<a href='/user?sessionId=" + sid + "'>?ㅻ줈媛湲?/a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\user\ReturnBookServlet.java =====
package was.version.servlet.user;

import Library.LibraryService;
import was.httpserver.*;
import model.*;

import java.io.IOException;
import java.util.List;

public class ReturnBookServlet implements HttpServlet {
    @Override
    public void service(HttpRequest request, HttpResponse response) throws IOException {
        ServletManager manager = request.getServletManager();

        LibraryService libraryService = manager.getLibraryService();
        SessionManager sessionManager = manager.getSessionManager();

        String sid = request.getParameter("sessionId");
        String title = request.getParameter("title");

        User user = sessionManager.getUser(sid);
        if (title == null) {
            List<Book> books = libraryService.getBorrowedBooks(user);

            response.writeBody("<h2>諛섎궔??梨낆쓣 ?좏깮?섏꽭??/h2>");
            response.writeBody("<ul>");

            for (Book book : books) {
                response.writeBody("<li>");
                response.writeBody(book.getTitle() + " - " + book.getAuthor());
                response.writeBody(" <a href='/returnBook?sessionId=" + sid
                        + "&title=" + book.getTitle() + "'>諛섎궔</a>");
                response.writeBody("</li>");
            }

            response.writeBody("</ul>");
            response.writeBody("<a href='/user?sessionId=" + sid + "'>?ㅻ줈媛湲?/a>");
            return;
        }

        boolean result = libraryService.returnBook(user, title);

        if (result) {
            response.writeBody("<p>" + title + " 諛섎궔 ?꾨즺!</p>");
        } else {
            response.writeBody("<p>諛섎궔 ?ㅽ뙣!</p>");
        }

        response.writeBody("<a href='/user?sessionId=" + sid + "'>?뚯븘媛湲?/a>");
    }
}

===== C:\Users\sswoo\OneDrive\바탕 화면\java\java_libraryV1\src\was\version\servlet\user\UserServlet.java =====
package was.version.servlet.user;

import was.httpserver.*;
import java.io.IOException;

public class UserServlet implements HttpServlet {
    @Override
    public void service(HttpRequest request, HttpResponse response) throws IOException {
        String sid = request.getParameter("sessionId");

        response.writeBody("<h2>?ъ슜??硫붾돱</h2>");

        response.writeBody("<ul>");
        response.writeBody("<li><a href='/bookList?sessionId=" + sid + "'>?꾩꽌 紐⑸줉</a></li>");
        response.writeBody("<li><a href='/borrowBook?sessionId=" + sid + "'>?꾩꽌 ?異?/a></li>");
        response.writeBody("<li><a href='/returnBook?sessionId=" + sid + "'>?꾩꽌 諛섎궔</a></li>");
        response.writeBody("<li><a href='/Overdue?sessionId=" + sid + "'>???異?紐⑸줉</a></li>");
        response.writeBody("<li><a href='/'>?덉쑝濡?/a></li>");
        response.writeBody("</ul>");
    }
}

